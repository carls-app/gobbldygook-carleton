<DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src='https://cdnjs.cloudflare.com/ajax/libs/fetch/0.10.0/fetch.min.js'></script>
<style>
#input label {
	display: inline-block;
}
.loading {
	opacity: 0.5;
}
</style>

<form id='input' onsubmit='main(); return false'>
	<button type='submit'>Go</button>
</form>

<div id="error"></div>

<pre id="courses"></pre>

<script>
'use strict'

function log() {
	console.log(arguments)
}

function status(response) {
	if (response.status >= 200 && response.status < 300) {
		return Promise.resolve(response)
	}
	else {
		return Promise.reject(new Error(response.statusText))
	}
}

function json(response) {
	return response.json()
}

function text(response) {
	return response.text()
}

function html(response) {
	var parser = new DOMParser()
	return parser.parseFromString(response, 'text/html')
}

function checkIfLoggedIn() {
	var errorBox = document.querySelector('#error')

	return fetch('https://www.stolaf.edu/sis/st-courses.cfm', {cache: 'no-cache', credentials: 'same-origin', mode: 'same-origin'})
		.then(status)
		.then(text)
		.then(html)
		.then(function(response) {
			console.log(response)
			var error = response.querySelector('.sis-error')
			if (error && error.textContent.trim() === 'Sorry, your session has timed out; please login again.') {
				errorBox.innerHTML = ''
				var msg = document.createElement('p')
				msg.textContent = 'Please log into the SIS in another tab, then push the "Reload SIS" button'
				errorBox.appendChild(msg)

				var btn = document.createElement('button')
				btn.type = 'button'
				btn.textContent = 'Reload SIS'
				btn.onclick = function() {
					errorBox.classList.add('loading')
					main()
				}
				errorBox.appendChild(btn)
				return false
			}
			else if (error) {
				errorBox.textContent = error.textContent
			}
			else {
				errorBox.classList.remove('loading')
				errorBox.textContent = ''
				return true
			}
		})
}


function getTermList() {
	return fetch('https://www.stolaf.edu/sis/st-courses.cfm', {cache: 'no-cache', credentials: 'same-origin', mode: 'same-origin'})
		.then(status)
		.then(text)
		.then(html)
		.then(function(response) {
			var termSelector = response.getElementsByName('searchyearterm')[0]
			if (!termSelector) {
				return []
			}
			return [].slice.call(termSelector.options).map(function(opt) {return opt.value}).map(Number)
		})
}

function getStudentId() {
	return fetch('https://www.stolaf.edu/sis/st-courses.cfm', {cache: 'no-cache', credentials: 'same-origin', mode: 'same-origin'})
		.then(status)
		.then(text)
		.then(html)
		.then(function(response) {
			var termSelector = response.getElementsByName('stnum')[0]
			if (!termSelector) {
				return null
			}
			return Number(termSelector.value.trim())
		})
}

function getItemsFromCell(sisCell) {
	return [].slice.call(sisCell.childNodes)
		.map(function(item) {
			return 'textContent' in item ? item.textContent.trim() : item.trim()
		})
		.filter(function(item) {
			return item && item.trim().length
		})
}

function removeInternalWhitespace(text) {
	return text.replace(/\s+/, ' ')
}

function convertToCourse(term, sisRow) {
	var mapping = ['deptnum', 'lab', 'name', 'halfsemester', 'credits', 'passfail', 'gereqs', 'times', 'locations', 'instructors']
	// returns a string like 20151 CSCI 273 L
	var tableRow = sisRow.children
	return {
		term: term,
		deptnum: removeInternalWhitespace(tableRow[0].textContent.trim()),
		lab: tableRow[1].textContent.trim() === 'L' ? true : false,
		name: tableRow[2].textContent.trim(),
		// halfsemester
		credits: Number(tableRow[4].textContent.trim()),
		gradetype: tableRow[5].textContent.trim(),
		gereqs: getItemsFromCell(tableRow[6]) || [],
		times: getItemsFromCell(tableRow[7]).map(removeInternalWhitespace) || [],
		locations: getItemsFromCell(tableRow[8]) || [],
		instructors: getItemsFromCell(tableRow[9]) || [],
	}
}

function getCourses(studentId, term) {
	var formData = new FormData()
	formData.append('stnum', studentId)
	formData.append('searchyearterm', term)
	// formData.append('x', 10)
	// formData.append('y', 9)

	return fetch('https://www.stolaf.edu/sis/st-courses.cfm', {method: 'POST', body: formData, cache: 'no-cache', credentials: 'same-origin', mode: 'same-origin'})
		.then(status)
		.then(text)
		.then(html)
		.then(function(response) {
			var courseRows = [].slice.call(response.querySelector('.sis-tblheader').parentElement.children).slice(2, -1)

			if (!courseRows) {
				return []
			}

			return [].slice.call(courseRows).map(function(row) {return convertToCourse(term, row)})
		})
}

function main() {
	var el = document.querySelector('#courses')
	el.innerHTML = 'Loadingâ€¦'

	checkIfLoggedIn()
		.then(function() {
			return Promise.all([getTermList(), getStudentId()])
		})
		.then(function(termsAndId) {
			var terms = termsAndId[0]
			var id = termsAndId[1]
			return Promise.all(terms.map(function(term){return getCourses(id, term)}))
		})
		.then(function(courses) {
			// flatten the array of courses
			return courses.reduce(function(a, b) {
				return a.concat(b);
			}, []);
		})
		.then(function(courses) {
			el.innerHTML = courses.map(function(c) {
				return c.term + ' ' + c.deptnum + ' ' + (c.lab ? 'L' : '') + JSON.stringify(c)
			}).join('\n')
			return courses
		})
		.then(console.log.bind(console))
}

main()

</script>
