general:
  branches:
    only:
      # self-explanatory?
      - master
      - stable
      # circleci testing branches
      - /^circle/
      # version tags (from https://github.com/sindresorhus/semver-regex)
      - /^v?(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?$/
  artifacts:
    - artifacts/

machine:
  pre:
    - mkdir -p ~/.yarn-cache
  node:
    version: stable

dependencies:
  pre:
    # Install Yarn
    - sudo apt-key adv --keyserver pgp.mit.edu --recv D101F7899D41F3C3
    - echo "deb http://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
    - sudo apt-get update -qq
    - sudo apt-get install -y -qq yarn
    - if ! which nodejs; then sudo ln -s $(which node) /usr/local/bin/nodejs; fi
  cache_directories:
    - ~/.yarn-cache
  override:
    - yarn install

test:
  pre:
    - node -v

  override:
    - npm run lint
    - ./node_modules/.bin/nyc npm test -- --reporter mocha-junit-reporter:
        environment:
          MOCHA_FILE: $CIRCLE_TEST_REPORTS/junit/test-results.xml
    - npm run build -- --no-progress

  #post:
    #- ./node_modules/.bin/nyc report --reporter=text-lcov | ./node_modules/.bin/coveralls
    #- bash <(curl -s https://codecov.io/bash)
